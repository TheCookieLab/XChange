name: Maven Release Publish (Disabled by Default)

on:
  workflow_dispatch:
    inputs:
      enable_release:
        description: Set to true to allow publishing a release
        required: true
        default: "false"
      release_version:
        description: Release version (for example 0.1.0)
        required: true
      next_snapshot_version:
        description: Next snapshot version (for example 0.2.0-SNAPSHOT)
        required: true

jobs:
  release:
    if: ${{ inputs.enable_release == 'true' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '25'
        cache: maven
    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
    - name: Configure git user
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    - name: Publish release
      env:
        MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_TOKEN_USER }}
        MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_TOKEN_PASS }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        mvn --batch-mode --no-transfer-progress \
          --settings etc/settings.xml \
          -Prelease-sign-artifacts,central-release-publish \
          -Dgpg.passphrase="$GPG_PASSPHRASE" \
          -DreleaseVersion="${{ inputs.release_version }}" \
          -DdevelopmentVersion="${{ inputs.next_snapshot_version }}" \
          -DlocalCheckout=true \
          -Darguments="--settings etc/settings.xml -Prelease-sign-artifacts,central-release-publish -Dgpg.passphrase=\"$GPG_PASSPHRASE\" -DskipIntegrationTests=true" \
          release:clean release:prepare release:perform
    - name: Publish next snapshot
      env:
        MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_TOKEN_USER }}
        MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_TOKEN_PASS }}
      run: |
        CURRENT_VERSION="$(sed -n 's:.*<version>\(.*\)</version>.*:\1:p' pom.xml | head -n1)"
        case "$CURRENT_VERSION" in
          *-SNAPSHOT) ;;
          *)
            echo "::error::Expected the post-release development version to be a SNAPSHOT but found '$CURRENT_VERSION'."
            exit 1
            ;;
        esac
        mvn --batch-mode --no-transfer-progress \
          --settings etc/settings.xml \
          -Dfmt.skip=true \
          -DskipIntegrationTests=true \
          clean deploy
